;-------------------------------------------------------------------------
; üõ∞Ô∏è VOID PROTOCOL v2.1 | Tiny Innovation Group Ltd
; -------------------------------------------------------------------------
; Environment: Heltec WiFi LoRa 32 V3
; Compliance:  NSA "Clean C++" & SEI CERT C++ Strict Enforcement
;-------------------------------------------------------------------------

; --- BASE CONFIGURATION (Shared by all roles) ---
[env]
platform = espressif32
board = heltec_wifi_lora_32_V3
framework = arduino

monitor_speed = 115200
monitor_filters = esp32_exception_decoder, time
lib_ldf_mode = chain

lib_deps = 
    jgromes/RadioLib@^7.5.0
    thingpulse/ESP8266 and ESP32 OLED driver for SSD1306 displays@^4.6.2

build_flags =
    -D REGION_EU868
    -D BOARD_V3
    -D HELTEC_BOARD=WIFI_LoRa_32_V3
    -D LoRaWAN_DEBUG_LEVEL=0
    -D SLOW_CLK_TPYE=0
    -D RADIO_NSS=8


; Strict Flags (Applied ONLY to our /src code to enforce NSA/CERT standards)
build_src_flags =
    ; 1. The "Zero Tolerance" Baseline
    -Wall                   ; Enable all standard warnings
    -Wextra                 ; Enable extra warnings
    -Werror                 ; FATAL: Treat ALL warnings as compilation errors

    ; 2. SEI CERT C++ / Type & Memory Safety
    -Wshadow                ; FATAL: Prevent variable shadowing (e.g., local var hiding global)
    -Wvla                   ; FATAL: Ban Variable Length Arrays (NSA No-Heap/Stack Smash rule)
    -Wconversion            ; FATAL: Catch implicit type conversions that lose data
    -Wsign-conversion       ; FATAL: Catch unsafe int to unsigned int conversions
    -Wcast-align            ; FATAL: Catch misaligned pointer casts (Strict Alignment)
    -Wold-style-cast        ; FATAL: Force C++ style casts (static_cast) over C-style (int)
    
    ; 3. Security & Optimization
    -Wformat-security       ; FATAL: Prevent printf string format vulnerabilities
    -D_FORTIFY_SOURCE=2     ; Enable buffer overflow checks at compile/run time
    -O2                     ; Optimize for speed and safe execution

; --- STATIC ANALYSIS (The "Automated Auditor") ---
; Runs Cppcheck and Clang-Tidy automatically on build
check_tool = cppcheck, clangtidy
check_skip_packages = yes
check_severity = high, medium
check_flags =
    cppcheck: --enable=all --suppress=missingIncludeSystem --inconclusive --std=c++14
    clangtidy: --checks=-*,cert-*,bugprone-*,clang-analyzer-*,performance-*
extra_scripts = post:sys_includes.py
; --- ENVIRONMENT 1: THE BUYER (MULE) ---
[env:buyer_demo]
build_flags =
    ${env.build_flags}
    -D ROLE_BUYER     ; Tells compiler this is Sat B
    -D DEMO=1         ; Enables the USB Handshake trigger

; --- ENVIRONMENT 2: THE SELLER (DISPENSER) ---
[env:seller_prod]
build_flags =
    ${env.build_flags}
    -D ROLE_SELLER    ; Tells compiler this is Sat A